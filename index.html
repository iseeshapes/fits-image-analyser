<html>
    <head>
        <link rel="stylesheet" type="text/css" href="css/site.css">
        <link rel="stylesheet" type="text/css" href="css/fits-header-table.css">
        <link rel="stylesheet" type="text/css" href="css/star-list.css">
        <link rel="stylesheet" type="text/css" href="css/star-details.css">
        <link rel="stylesheet" type="text/css" href="css/image-overlay.css">

        <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script-->
        <script src="js/lib/jquery.min.js"></script>
        <script src="js/lib/wcs.js"></script>

        <script src="js/image.js"></script>
        <script src="js/catalog-item.js"></script>

        <script src="js/angle.js"></script>
        <!--script src="js/sip-data.js"></script-->
        <script src="js/fits-header.js"></script>
        <script src="js/fits-image.js"></script>
        <script src="js/fits-header-table.js"></script>
        <script src="js/site-controller.js"></script>
        <script src="js/star-selector.js"></script>
        <script src="js/star-list.js"></script>
        <script src="js/star-details-table.js"></script>
        <script src="js/star-details-button.js"></script>
        <script src="js/star-finder.js"></script>
        <script src="js/image-overlay.js"></script>

        <style type="text/css">
        </style>
    </head>
    <body>
        <h1>Fits Image Analyser</h1>

        <div class="row" style="display: none">
            <div style="width: 900px">Upload a WCS FITS Header file below to create a map of the stars in your image.<p><a href="https://nova.astrometery.net">astronometry.net</a> can be used to create the WCS Header from your fits image.</div>
        </div>

        <div id="fileSelectRow" class="row">
            <label for="fileInput">WCS File</label>
            <input id="fileInput" type="file" />
        </div>

        <div id="optionsRow" class="row">
            <div class="row-container">
                <button id="fitsHeaderButton" class="menu">Fits Header</button>
            </div>
            <div class="row-container">
                <button id="starListButton" class="menu">Star Table</button>
            </div>

            <div id="selectCatalogContainer" class="row-container">
                <div>Select Star</div>
                <div>
                    <select id="catalogSelector">
                        <option>No Catalog</option>
                    </select>
                </div>
                <div>
                    <select id="catalogItemSelector">
                        <option>No Stars</option>
                    </select>
                </div>
            </div>

            <div id="zoomContainer" class="row-container">
                <div>Zoom</div>
                <select id="zoom">
                    <option value="0.25">25%</option>
                    <option value="0.5">50%</option>
                    <option value="0.75">75%</option>
                    <option value="1">100%</option>
                    <option value="2">200%</option>
                    <option value="4">400%</option>
                </select>
            </div>

            <div class="row-container">
                <button id="starDetailsButton" class="menu">Show Details</button>
            </div>
            <div class="row-container">
                <button class="menu">Help</button>
            </div>
        </div>

        <div class="row">
            <div id="image-container" class="row-container">
                <canvas id="canvas"></canvas>
                <svg id="image" class="image">
                    <defs>
                        <svg id="catalog-star" viewBox="-2 -2 4 4">
                            <path d="M  0.0  ,-2.0
                                     L -1.732, 1.0
                                     L  1.732, 1.0
                                     Z
                                     M 0, -0.9
                                     A 0.9 0.9 0 1 1 0  0.9
                                     A 0.9 0.9 0 1 1 0 -0.9
                                     Z"/>
                             <path d="M  0.0  ,-2.0
                                      L -1.732, 1.0
                                      L  1.732, 1.0
                                      Z" class="overlay" />
                         </svg>

                        <svg id="image-star" viewBox="-2 -2 4 4">
                            <!--rect x="-1" y="-1" width="2" height="2" class="overlay" /-->
                            <path d="M -1.0,-1.0
                                     L -1.0, 1.0
                                     L  1.0, 1.0
                                     L  1.0,-1.0
                                     Z
                                     M 0, -0.9
                                     A 0.9 0.9 0 1 1 0  0.9
                                     A 0.9 0.9 0 1 1 0 -0.9
                                     Z" />
                            <rect x="-2" y="-2" width="4" height="4" class="overlay" />
                        </svg>
                    </defs>
                </svg>
            </div>
        </div>
    </body>

    <div id="fitsHeaderBackground" class="popup-background" style="display: none">
        <div id="fitsHeaderContainer" class="popup-container">
            <table id="fitsHeaderTable" class="popup-table fits-header-table">
                <thead>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div id="starListBackground" class="popup-background" style="display: none">
        <div id="starListContainer1" class="popup-container1">
            <div id="starListContainer2" class="popup-container2">
                <table id="starListTable" class="popup-table star-list-table">
                    <thead>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="starDetailsBackground" class="popup-background" style="display: none">
        <div id="starDetailsContainer1" class="popup-container1">
            <div id="starDetailsContainer2" class="popup-container2">
                <table id="starDetailsTable" class="popup-table star-details-table">
                    <thead>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        $(function() {
            let siteController = new SiteController();
            let fitsHeaderTable = new FitsHeaderTable("fitsHeaderTable", siteController);
            let starSelector = new StarSelector("catalogSelector", "catalogItemSelector", siteController);
            let starList = new StarList("starListTable", siteController);
            let starDetailsTable = new StarDetailsTable("starDetailsTable", siteController);
            let starDetailsButton = new StarDetailsButton("starDetailsButton", siteController);
            let imageOverlay = new ImageOverlay("image", siteController);
            let fitsImage = new FitsImage("canvas", siteController);
            siteController.addSearchListener(fitsHeaderTable);
            siteController.addSearchListener(starSelector);
            siteController.addSearchListener(starList);
            siteController.addSearchListener(starDetailsTable);
            siteController.addSearchListener(starDetailsButton);
            siteController.addSearchListener(imageOverlay);

            siteController.addDataListener(fitsImage);

            $("#zoom").change(() => {
                var zoom = $("#zoom").val();
                imageOverlay.zoom(zoom);
                fitsImage.zoom(zoom);
            });

            $("#fitsHeaderButton").click(() => {
                $("#fitsHeaderBackground").css("display", "inline-block");
            });

            $("#fitsHeaderBackground").click(() => {
                $("#fitsHeaderBackground").css("display", "none");
            });

            $("#starListButton").click(() => {
                $("#starListBackground").css("display", "inline-block");
            });

            $("#starListBackground").click(() => {
                $("#starListBackground").css("display", "none");
            });

            $("#starListContainer2").click((e) => {
                e.stopPropagation();
            });

            $("#starDetailsButton").click(() => {
                $("#starDetailsBackground").css("display", "inline-block");
            });

            $("#starDetailsBackground").click(() => {
                $("#starDetailsBackground").css("display", "none");
            });

            $("#starDetailsContainer2").click((e) => {
                e.stopPropagation();
            });

            function loadFile(file) {
                if(!file) {
                    return;
                }
                let reader = new FileReader();
                reader.onload = function(e) {
                    var contents = e.target.result;
                    siteController.loadData(contents);
                };
                reader.readAsArrayBuffer(file);
            }

            $("#fileInput").change(e => {
                console.log(e.target.files[0]);
                loadFile(e.target.files[0]);
            });

            let oReq = new XMLHttpRequest();
            oReq.open("GET", "/data/Horus_Light_20_secs_2019-01-30T23-14-59_005.new", true);
            oReq.responseType = "arraybuffer";

            oReq.onload = function (oEvent) {
              let arrayBuffer = oReq.response; // Note: not oReq.responseText
              if (arrayBuffer) {
                  siteController.loadData(arrayBuffer);
              }
            }
            oReq.send(null);
        });
    </script>
</html>
